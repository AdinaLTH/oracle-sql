-- 아이디 board
-- 비밀번호 1234
CREATE TABLE CATEGORIES (
    CATEGORY_ID   NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NAME          VARCHAR2(50) NOT NULL,
    DISPLAY_ORDER NUMBER DEFAULT 0
);

CREATE TABLE POSTS (
    POST_ID       NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CATEGORY_ID   NUMBER NOT NULL,
    TITLE         VARCHAR2(200) NOT NULL,
    CONTENT       CLOB NOT NULL,
    NICKNAME      VARCHAR2(50) NOT NULL,
    PASSWORD      VARCHAR2(100) NOT NULL,
    VIEW_COUNT    NUMBER DEFAULT 0,
    LIKE_COUNT    NUMBER DEFAULT 0,
    DISLIKE_COUNT NUMBER DEFAULT 0,
    NET_LIKES     NUMBER GENERATED ALWAYS AS (LIKE_COUNT - DISLIKE_COUNT) VIRTUAL,
    CREATED_AT    TIMESTAMP DEFAULT SYSTIMESTAMP,
    CONSTRAINT FK_POST_CATEGORY FOREIGN KEY (CATEGORY_ID) REFERENCES CATEGORIES(CATEGORY_ID)
);

CREATE TABLE COMMENTS (
    COMMENT_ID      NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    POST_ID         NUMBER NOT NULL,
    PARENT_COMMENT_ID NUMBER,
    NICKNAME        VARCHAR2(50) NOT NULL,
    PASSWORD        VARCHAR2(100) NOT NULL,
    CONTENT         VARCHAR2(1000),
    EMOTICON_URL    VARCHAR2(500),
    CREATED_AT      TIMESTAMP DEFAULT SYSTIMESTAMP,
    GROUP_ID        NUMBER,
    DEPTH           NUMBER DEFAULT 0,
    TARGET_NICKNAME VARCHAR2(50),
    CONSTRAINT FK_COMMENT_POST FOREIGN KEY (POST_ID) REFERENCES POSTS(POST_ID) ON DELETE CASCADE,
    CONSTRAINT FK_COMMENT_PARENT FOREIGN KEY (PARENT_COMMENT_ID) REFERENCES COMMENTS(COMMENT_ID)
);

CREATE TABLE FILES (
    FILE_ID           NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    POST_ID           NUMBER NOT NULL,
    ORIGINAL_FILENAME VARCHAR2(255) NOT NULL,
    STORED_FILENAME   VARCHAR2(255) NOT NULL,
    FILE_PATH         VARCHAR2(500) NOT NULL,
    FILE_TYPE         VARCHAR2(50),
    CREATED_AT        TIMESTAMP DEFAULT SYSTIMESTAMP,
    CONSTRAINT FK_FILE_POST FOREIGN KEY (POST_ID) REFERENCES POSTS(POST_ID) ON DELETE CASCADE
);

CREATE INDEX IDX_POSTS_NET_LIKES ON POSTS((LIKE_COUNT - DISLIKE_COUNT) DESC, POST_ID DESC);

CREATE INDEX IDX_POSTS_CAT_ID ON POSTS(CATEGORY_ID, POST_ID DESC);

CREATE INDEX IDX_COMMENTS_SORT ON COMMENTS(POST_ID, GROUP_ID, COMMENT_ID);